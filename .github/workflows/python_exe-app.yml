# Version 1.2 - Workflow para SVA (Seed Vision Analyzer) - Corrigido
name: Build SVA Executable and Release

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # Necess√°rio para criar Releases

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Set up Python 3.11.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.11.9'

    - name: üîé Extract version from SVA_15.6.py
      id: extract_version
      run: |
        $version = (Get-Content SVA_15.6.py | Select-String -Pattern 'CURRENT_VERSION\s*=\s*\"(.*?)\"' | ForEach-Object { $_.Matches.Groups[1].Value })
        echo "VERSION=$version" >> $env:GITHUB_ENV
      shell: powershell

    - name: ‚öôÔ∏è Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Core: PySide6 (Interface) e OpenCV (Processamento)
        pip install PySide6 opencv-python numpy
        # Cient√≠fico/Estat√≠stica: Pandas, Statsmodels, Matplotlib, ReportLab
        pip install pandas statsmodels matplotlib reportlab
        pip install pyqtgraph
        # Empacotamento
        pip install pyinstaller
        # Instala YOLOv8 (Ultralytics)
        pip install ultralytics
        # Depend√™ncias que o PyInstaller pode n√£o ver
        pip install scipy pytz
      
    - name: üì¶ Build executable with PyInstaller
      run: |
        pyinstaller --noconfirm --onedir --windowed --clean --debug=all `
        --name "SVA_${{env.VERSION}}" `
        --icon "icone.ico" `
        --add-data "icone.ico;." `
        --add-data "logo.png;." `
        --add-data "logo2.png;." `
        --add-data "SVA;SVA" `
        --hidden-import "ultralytics" `
        --hidden-import "ultralytics.utils" `
        --hidden-import "ultralytics.engine.model" `
        --hidden-import "ultralytics.models.yolo" `
        --hidden-import "ultralytics.data" `
        --hidden-import "pandas" `
        --hidden-import "scipy" `
        --hidden-import "scipy.signal" `
        --hidden-import "pytz" `
        --hidden-import "tqdm" `
        --hidden-import "cv2" `
        --hidden-import "matplotlib.backends.backend_qtagg" `
        --hidden-import "PySide6.QtCore" `
        --hidden-import "PySide6.QtGui" `
        --hidden-import "PySide6.QtWidgets" `
        --hidden-import "PySide6.QtNetwork" `
        --collect-all PySide6 `
        --exclude-module PySide6.QtWebEngineCore ` # <-- FIX APLICADO AQUI
        SVA_15.6.py

    - name: üì¶ Compress executable folder
      run: |
        # O nome da pasta gerada pelo --onedir √© o mesmo do --name
        $folderName = "SVA_${{env.VERSION}}"
        $zipFileName = "${folderName}.zip"
        # Comprime a pasta em um arquivo ZIP
        Compress-Archive -Path "dist\$folderName" -DestinationPath "dist\$zipFileName"
      shell: powershell

    - name: ‚¨ÜÔ∏è Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: SVA_${{env.VERSION}}
        path: dist/SVA_${{env.VERSION}}.zip

    - name: üè∑Ô∏è Create GitHub Release Tag
      id: create_tag
      run: echo "RELEASE_TAG=v${{env.VERSION}}" >> $env:GITHUB_ENV
      shell: powershell

    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{env.RELEASE_TAG}}
        name: "SVA_${{env.VERSION}}"
        body: |
          Automatic release of Seed Vision Analyzer version ${{env.VERSION}}.
        draft: false
        prerelease: false
        overwrite: true
        files: |
          dist/SVA_${{env.VERSION}}.zip
          SVA/best.pt
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
