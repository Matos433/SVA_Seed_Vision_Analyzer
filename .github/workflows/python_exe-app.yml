# Version 1.0 - Workflow para SVA (Seed Vision Analyzer)
name: Build SVA Executable and Release

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  build:
    # Recomendado usar um runner mais r√°pido ou Windows Server 2022 para performance
    runs-on: windows-latest
    permissions:
      contents: write # Necess√°rio para criar Releases

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Set up Python 3.11.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.11.9'

    - name: üîé Extract version from SVA_15.7.py
      id: extract_version
      # Busca o valor da vari√°vel CURRENT_VERSION dentro do arquivo SVA_15.5.py
      # ATEN√á√ÉO: Ajustado para o nome do seu arquivo mais recente
      run: |
        $version = (Get-Content SVA_15.7.py | Select-String -Pattern 'CURRENT_VERSION\s*=\s*\"(.*?)\"' | ForEach-Object { $_.Matches.Groups[1].Value })
        echo "VERSION=$version" >> $env:GITHUB_ENV
      shell: powershell

    - name: ‚öôÔ∏è Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Core: PySide6 (Interface) e OpenCV (Processamento)
        pip install PySide6 opencv-python numpy
        # Cient√≠fico/Estat√≠stica: Pandas, Statsmodels, Matplotlib, ReportLab
        pip install pandas statsmodels matplotlib reportlab
        pip install pyqtgraph
        # Empacotamento
        pip install pyinstaller
        # Instala YOLOv8 com vers√£o espec√≠fica para PyInstaller
        # Instala YOLOv8 com vers√£o mais recente para garantir compatibilidade
        pip install ultralytics --no-deps 
      
    - name: ‚öôÔ∏è Adjust recursion limit (Optional, for large apps)
      run: python -c "import sys; sys.setrecursionlimit(5000)"

    # Linha 60 (In√≠cio do bloco 'Build executable with PyInstaller')
    - name: üì¶ Build executable with PyInstaller
      run: |
        # YOLOv8 requer esta corre√ß√£o para funcionar
        pip install ultralytics==8.0.22 --no-deps # Instala YOLOv8 com vers√£o correta (sem depend√™ncias)

        # CORRE√á√ÉO DE OTIMIZA√á√ÉO: Adicionado --clean e --strip
        pyinstaller --noconfirm --onefile --windowed --clean --strip `
        --name "SVA_${{env.VERSION}}.exe" `
        --icon "icone.ico" `
        --add-data "icone.ico;." `
        --add-data "logo.png;." `
        --add-data "logo2.png;." `
        --add-data "SVA;SVA" `
        --hidden-import "matplotlib.backends.backend_qtquick" `
        --hidden-import "matplotlib.backends.backend_qtagg" `
        --hidden-import "ultralytics `
        "SVA_15.6.py"

    - name: ‚¨ÜÔ∏è Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: SVA_${{env.VERSION}}
        # CORRE√á√ÉO: Caminho do arquivo usa o nome din√¢mico
        path: dist/SVA_${{env.VERSION}}.exe

    - name: üè∑Ô∏è Create GitHub Release Tag
      id: create_tag
      run: echo "RELEASE_TAG=v${{env.VERSION}}" >> $env:GITHUB_ENV
      shell: powershell

    - name: üöÄ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{env.RELEASE_TAG}}
        name: "SVA_${{env.VERSION}}"
        body: |
          Automatic release of Seed Vision Analyzer version ${{env.VERSION}}.
          Includes improvements in startup speed and UI corrections.
        draft: false
        prerelease: false
        # CORRE√á√ÉO CR√çTICA: Adiciona o best.pt na Release junto com o EXE
        files: |
          dist/SVA_${{env.VERSION}}.exe
          SVA/best.pt
          SVA_15.6.py
          Train_Model_Seeds_11
      env:
        GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}