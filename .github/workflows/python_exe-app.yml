name: Build SVA Executable and Release

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  build:
    # Recomendado usar um runner mais rÃ¡pido ou Windows Server 2022 para performance
    runs-on: windows-latest
    permissions:
      contents: write # NecessÃ¡rio para criar Releases

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Set up Python 3.11.9
      uses: actions/setup-python@v3
      with:
        python-version: '3.11.9'

    - name: ðŸ”Ž Extract version from SVA_15.4.py
      id: extract_version
      # Busca o valor da variÃ¡vel CURRENT_VERSION dentro do arquivo SVA_15.4.py
      run: |
        $version = (Get-Content SVA_15.4.py | Select-String -Pattern 'CURRENT_VERSION\s*=\s*\"(.*?)\"' | ForEach-Object { $_.Matches.Groups[1].Value })
        echo "VERSION=$version" >> $env:GITHUB_ENV
      shell: powershell

    - name: âš™ï¸ Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Core: PySide6 (Interface) e OpenCV (Processamento)
        pip install PySide6 opencv-python numpy
        # CientÃ­fico/EstatÃ­stica: Pandas, Statsmodels, Matplotlib, ReportLab
        pip install pandas statsmodels matplotlib reportlab
        # Deep Learning/GrÃ¡ficos: Ultralytics, pyqtgraph
        pip install ultralytics pyqtgraph
        # Empacotamento
        pip install pyinstaller
      
    - name: âš™ï¸ Adjust recursion limit (Optional, for large apps)
      run: python -c "import sys; sys.setrecursionlimit(5000)"

    - name: ðŸ“¦ Build executable with PyInstaller
      run: |
        pyinstaller --noconfirm --onefile --windowed `
        --name "SVA_Seed_Vision_Analyzer_v${{ env.VERSION }}" `
        --icon "icone.ico" `
        --add-data "icone.ico;." `
        --add-data "logo.png;." `
        --add-data "logo2.png;." `
        --add-data "SVA;SVA" `
        --hidden-import "matplotlib.backends.backend_qtquick" `
        --hidden-import "matplotlib.backends.backend_qtagg" `
        --hidden-import "ultralytics" `
        "SVA_15.4.py"

    - name: â¬†ï¸ Upload executable artifact
      uses: actions/upload-artifact@v4
      with:
        name: SVA_${{ env.VERSION }}
        path: dist/SVA_Seed_Vision_Analyzer_${{ env.VERSION }}.exe

    - name: ðŸ·ï¸ Create GitHub Release Tag
      id: create_tag
      run: echo "RELEASE_TAG=${{ env.VERSION }}" >> $env:GITHUB_ENV
      shell: powershell

    - name: ðŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "Release SVA ${{ env.VERSION }}"
        body: |
          Automatic release of Seed Vision Analyzer version ${{ env.VERSION }}.
          Includes improvements in startup speed and UI corrections.
        draft: false
        prerelease: false
        files: |
          dist/SVA_Seed_Vision_Analyzer_v${{ env.VERSION }}.exe
          SVA/best.pt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
