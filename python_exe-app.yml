# Version 0.17

name: Build Executable

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
    - name: Check out the repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'

    - name: Extract version from Variaveis.py
      id: extract_version
      run: |
        version=$(python -c "import re; 
        with open('D:/a/DownloadTramas/DownloadTramas/BaseDados/Variaveis.py', encoding='utf-8') as f:
            print(re.search(r'^version\s*=\s*\"(.*?)\"', f.read(), re.MULTILINE).group(1))")
        echo "VERSION=$version" >> $GITHUB_ENV
      shell: bash

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install bs4
        pip install tkcalendar
        pip install ttkthemes
        pip install pygame
        pip install pandas
        pip install reportlab
        pip install folium
        pip install geopandas
        pip install joblib
        pip install tqdm
        pip install openpyxl
        pip install tkintermapview
        pip install pyshp
      if: contains(env.VERSION, 'release')  || contains(env.VERSION, 'RC')

    - name: Adjust recursion limit
      run: python -c "import sys; sys.setrecursionlimit(5000)"

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --noconfirm --onefile --windowed --icon "D:/a/DownloadTramas/DownloadTramas/Assets/Icone/LG_new.ico" --add-data "D:/a/DownloadTramas/DownloadTramas/Assets;Assets" --hidden-import "babel.numbers" --hidden-import "openpyxl.cell._writer" "D:/a/DownloadTramas/DownloadTramas/main.py" --distpath "dist" --workpath "build" --specpath "spec" --manifest "D:/a/DownloadTramas/DownloadTramas/BaseDados/manifest.xml" --splash "D:/a/DownloadTramas/DownloadTramas/Assets/Logo/Logo-com-fundo.jpeg" --optimize=2 --hidden-import "pyi_splash"
      if: contains(env.VERSION, 'release')  || contains(env.VERSION, 'RC')

    - name: Rename executable with version
      run: |
        REN dist\main.exe Download_Tramas_v%VERSION%.exe
      shell: cmd
      if: contains(env.VERSION, 'release')  || contains(env.VERSION, 'RC')

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: executable
        path: dist
      if: contains(env.VERSION, 'release')  || contains(env.VERSION, 'RC')

    - name: Generate dynamic tag name
      id: generate_tag
      run: echo "::set-output name=tag_name::Automatic_release_$(date +'%Y%m%d%H%M%S')"
      if: contains(env.VERSION, 'release')  # Só executa se 'release' estiver na versão

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      with:
        tag_name: ${{ steps.generate_tag.outputs.tag_name }}
        release_name: "${{ env.VERSION }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      if: contains(env.VERSION, 'release')  # Só executa se 'release' estiver na versão

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: dist/Download_Tramas_v${{ env.VERSION }}.exe
        asset_name: Download_Tramas_v${{ env.VERSION }}.exe
        asset_content_type: application/octet-stream
      if: contains(env.VERSION, 'release')  # Só executa se 'release' estiver na versão